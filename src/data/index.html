<html>
<head>
	<meta charset="UTF-8">
	<title>Vieraskirja</title>
	<link rel="stylesheet" href="library/bootstrap.min.css" >
	<script src="library/popper.min.js" ></script>
	<script src="library/vue.min.js" ></script>
	<script src="library/jquery-3.2.1.min.js" ></script>
	<script src="library/bootstrap.min.js" ></script>
</head>
 <body> 
	<div class="container" id="guestbook">
		<div class="jumbotron">
			<h2>Salo Iot hacklab</h2>
			<h4>Vieraskirja v2</h4>
		</div>
		<form v-on:submit = "onCreate">
			<div class="form-group">
				<input type="text" class="form-control input-sm" name="author" v-model="author" placeholder="Nimimerkki">
			</div>
			<div class="form-group">
				<input type="text" class="form-control input-sm" name="text" v-model="text" placeholder="Kommentti t‰h‰n">
			</div>     
			<div class="form-group text-right">   
				<button type="submit" class="btn btn-primary btn-lg">L‰het‰</button>
			</div>	  
		</form>
		<div class="comment" v-for="(comment, index) in comments"  >
			<h3>{{toDate(comment.time)}} Nimimerkki: {{comment.author}}</h3>
			<p>{{comment.text}}</p> 
		</div>	
	<div>    
 </body>
 <script>
 new Vue({
 	el: '#guestbook',
 	data: {
 		value: 'test',
 		text: "",
 		author: "",
 		comments: []
 	},
	//Alussa ladataan lista kommenteista
 	created: function () {
 		this.loadList();
 	},
 	methods: {
		//Muuntaa millisekunnit tekstiksi
 		toDate: function (millis) {
 			return new Date(millis).toString();
 		},
		//Lataa yksi kommenti
 		loadEntry: function (name) {
 			$.ajax({
 				context: this,
 				type: "GET",
 				dataType: 'json',
 				url: "http://www.salohack.fi/entry?file=" + name.substring(9, 22),
 				success: function (result) {
 					console.log(result);
					//Lis‰‰ kommentti listaan
 					this.comments.push(result);
 				}
 			});
 		},
		//Lataa lista kommenteista
 		loadList: function () {
 			$.ajax({
 				context: this,
 				type: "GET",
 				dataType: 'json',
 				url: "http://www.salohack.fi/list",
 				success: function (result) {
 					console.log(result);
					//Vaihda listan j‰rjestyst‰ niin ett‰ uusin on ylh‰‰ll‰
 					result.reverse();
					//Tyhjenn‰ vanhat kommentit
 					this.comments = [];
					//Lataa kommentit puolen sekunnin v‰lein ettei esp8622 rasitu liikaa
 					for (var i = 0; i < result.length; i++) {
 						setTimeout(this.loadEntry, i * 500, result[i].name);
 					}
 				}
 			});
 		},
		//L‰het‰ uusi kommentti palvelimelle
 		onCreate: function (e) {
 			e.preventDefault()
 			$.ajax({
 				context: this,
 				type: "POST",
 				dataType: 'json',
 				contentType: 'application/json; charset=UTF-8', // This is the money shot
 				data: JSON.stringify({
 					author: this.author,
 					text: this.text,
 					time: new Date().getTime()
 				}),
 				url: "http://www.salohack.fi/entry?time=" + new Date().getTime() 
 			}).done(function (result) {
					//Tyhjenn‰ lomake
 					this.author = '';
 					this.text = '';
					//Lataa lista uudestaan
 					this.loadList();
 				}).fail(function(err){
					console.log(err);
					//Tyhjenn‰ lomake
 					this.author = '';
 					this.text = '';
					//Lataa lista uudestaan
 					this.loadList();
				});
 		}
 	}
 });            
 </script>
 </html>
